class l{constructor(){this.loadedElements=new WeakSet,this.svgCache=new Map,this.pendingRequests=new Map}async fetchSvg(e){const t=e.replace(/^\/+/,"/");if(this.svgCache.has(t))return this.svgCache.get(t);if(this.pendingRequests.has(t))return this.pendingRequests.get(t);const a=fetch(t,{cache:"default",headers:{"Cache-Control":"max-age=3600"}}).then(async s=>{if(!s.ok)throw new Error(`Failed to load SVG: ${s.status}`);const i=await s.text();return this.svgCache.set(t,i),i}).catch(s=>{throw console.error(`Ошибка при загрузке SVG из ${t}:`,s),s}).finally(()=>{this.pendingRequests.delete(t)});return this.pendingRequests.set(t,a),a}createSvgElement(e,t){const a=new DOMParser().parseFromString(e,"image/svg+xml").documentElement,s=t.getAttribute("class");return s&&a.setAttribute("class",s),(t.classList.contains("language-icon-ru")||t.classList.contains("language-icon-en"))&&(a.removeAttribute("width"),a.removeAttribute("height")),a}async loadSvg(e){const t=e.getAttribute("data-svg-src");if(t&&e.parentNode&&!(e.hasAttribute("data-svg-loaded")||this.loadedElements.has(e)))try{const a=await this.fetchSvg(t);if(!e.parentNode)return;const s=this.createSvgElement(a,e);e.parentNode.replaceChild(s,e),s.setAttribute("data-svg-loaded","true"),this.loadedElements.add(s)}catch(a){console.error("Ошибка при загрузке SVG:",a)}}async init(){const e=Array.from(document.querySelectorAll("[data-svg-src]:not([data-svg-loaded])")).filter(r=>r.parentNode);if(e.length===0)return;const t=new Map;e.forEach(r=>{const c=r.getAttribute("data-svg-src");if(!c)return;const n=c.replace(/^\/+/,"/");t.has(n)||t.set(n,[]),t.get(n).push(r)});const s=Array.from(t.keys()).map(r=>this.fetchSvg(r));await Promise.allSettled(s);const i=20;for(let r=0;r<e.length;r+=i){const n=e.slice(r,r+i).map(o=>this.loadSvg(o));await Promise.allSettled(n),r+i<e.length&&await new Promise(o=>{window.requestIdleCallback?requestIdleCallback(()=>o(),{timeout:16}):setTimeout(o,0)})}}}const h=new l;export{l as SvgLoader,h as globalSvgLoader};
